# v1.0 未実装機能 実装計画

## 概要

v1.0リリースに必要な未実装機能を洗い出し、実装計画を策定する。

## 調査結果（2025-12-15）

### CLI実装状況

| コマンド                        | クラス実装 | Descriptor | 登録 | 状態   |
| ------------------------------- | ---------- | ---------- | ---- | ------ |
| `storyteller element character` | ✅         | ❌         | ❌   | 要修正 |
| `storyteller element setting`   | ❌         | ❌         | ❌   | 要実装 |
| `storyteller lsp validate`      | ❌         | ❌         | ❌   | 要実装 |

### MCP実装状況

| ツール                       | 定義 | 実装               | 状態        |
| ---------------------------- | ---- | ------------------ | ----------- |
| `element_create` (character) | ✅   | ⚠️ CLI依存         | CLI修正必要 |
| `element_create` (setting)   | ✅   | ❌ "not supported" | 要実装      |
| `lsp_validate`               | ✅   | ⚠️ CLI依存         | CLI修正必要 |
| `lsp_find_references`        | ✅   | ⚠️ CLI依存         | CLI修正必要 |

### LLM/OpenRouter実装状況

| 機能                         | 状態           |
| ---------------------------- | -------------- |
| `src/llm/` ディレクトリ      | ❌ 存在しない  |
| LLMProvider インターフェース | ⚠️ sample/のみ |
| OpenRouterProvider           | ❌ 未実装      |
| MockLLMProvider              | ⚠️ sample/のみ |
| 設定ファイルローダー         | ❌ 未実装      |

---

## 実装タスク

### Issue #1: element コマンド完成（CLI + MCP）

**優先度**: 高 **見積もり**: 中規模

#### タスク

1. `src/cli/modules/element/index.ts` 作成（グループハンドラー）
2. `src/cli/modules/element/character.ts` にDescriptor追加
3. `src/cli/modules/element/setting.ts` 新規作成
4. `src/cli/modules/index.ts` に登録
5. `src/mcp/tools/definitions/element_create.ts` 修正（setting対応）

#### 実装詳細

**element/index.ts（新規）**

```typescript
import { CommandDescriptor, CommandRegistry } from "../../types.ts";
import { BaseCliCommand } from "../../base_command.ts";
import { createLegacyCommandDescriptor } from "../../legacy_adapter.ts";
import { elementCharacterCommandDescriptor } from "./character.ts";
import { elementSettingCommandDescriptor } from "./setting.ts";

class ElementCommand extends BaseCliCommand {
  override readonly name = "element" as const;
  constructor(private readonly registry: CommandRegistry) {
    super([]);
  }
  protected handle(context: CommandContext) {
    // ヘルプ表示
  }
}

export function createElementDescriptor(
  registry: CommandRegistry,
): CommandDescriptor {
  return createLegacyCommandDescriptor(new ElementCommand(registry), {
    summary: "Manage story elements (characters, settings)",
    usage: "storyteller element <subcommand>",
    children: [
      elementCharacterCommandDescriptor,
      elementSettingCommandDescriptor,
    ],
  });
}
```

**character.ts（Descriptor追加）**

```typescript
export const elementCharacterCommandDescriptor: CommandDescriptor =
  createLegacyCommandDescriptor(new ElementCharacterCommand(), {
    summary: "Create a new character element",
    usage: "storyteller element character --name <name> --role <role>",
    options: [
      {
        name: "--name",
        summary: "Character name",
        type: "string",
        required: true,
      },
      { name: "--id", summary: "Character ID", type: "string" },
      {
        name: "--role",
        summary: "Role (protagonist/antagonist/supporting/guest)",
        type: "string",
        required: true,
      },
      { name: "--summary", summary: "Character summary", type: "string" },
      { name: "--traits", summary: "Traits (comma-separated)", type: "string" },
      {
        name: "--with-details",
        summary: "Include details skeleton",
        type: "boolean",
      },
      { name: "--json", summary: "Output as JSON", type: "boolean" },
    ],
  });
```

**setting.ts（新規）**

```typescript
export class ElementSettingCommand extends BaseCliCommand {
  override readonly name = "setting" as const;
  override readonly path = ["element", "setting"] as const;

  protected async handle(context: CommandContext) {
    // Setting型に準拠したファイルを生成
  }
}

export const elementSettingCommandDescriptor: CommandDescriptor = ...
```

---

### Issue #2: lsp validate コマンド実装

**優先度**: 高 **見積もり**: 中規模

#### タスク

1. `src/cli/modules/lsp/validate.ts` 新規作成
2. `src/cli/modules/lsp/index.ts` のchildren配列に追加
3. MCP `lsp_validate` ツールのCLI連携確認

#### 実装詳細

**validate.ts（新規）**

```typescript
export class LspValidateCommand extends BaseCliCommand {
  override readonly name = "validate" as const;
  override readonly path = ["lsp", "validate"] as const;

  protected async handle(context: CommandContext) {
    // 1. ファイルパスを取得
    // 2. LSPのDiagnostics機能を呼び出し
    // 3. 結果をフォーマットして出力
  }
}

export const lspValidateCommandDescriptor: CommandDescriptor =
  createLegacyCommandDescriptor(new LspValidateCommand(), {
    summary: "Validate manuscripts for entity references",
    usage: "storyteller lsp validate <file> [--dir] [--recursive]",
    options: [
      { name: "--dir", summary: "Directory to validate", type: "string" },
      { name: "--recursive", summary: "Recursive validation", type: "boolean" },
      { name: "--json", summary: "Output as JSON", type: "boolean" },
    ],
  });
```

---

### Issue #3: OpenRouter/LLM プロバイダー実装

**優先度**: 中 **見積もり**: 大規模

#### タスク

1. `src/llm/` ディレクトリ構造作成
2. LLMProvider インターフェース定義
3. OpenRouterProvider 実装
4. MockLLMProvider 実装（テスト用）
5. 設定ファイルローダー実装
6. MCPツールへの統合

#### ディレクトリ構造

```
src/llm/
├── config/
│   ├── llm-config.ts      # 型定義
│   └── loader.ts          # 設定ローダー
├── providers/
│   ├── provider.ts        # インターフェース
│   ├── openrouter.ts      # OpenRouter実装
│   ├── mock.ts            # モック実装
│   └── factory.ts         # ファクトリー
└── index.ts               # エクスポート
```

#### 設定ファイル形式

```json
// storyteller.llm.json
{
  "provider": "openrouter",
  "model": "anthropic/claude-3-haiku",
  "providerOrder": ["Cerebras"],
  "timeout": 30000,
  "retry": {
    "maxRetries": 3,
    "initialDelay": 1000,
    "maxDelay": 10000,
    "backoff": "exponential"
  }
}
```

---

### Issue #4: MCP element_create 完全実装

**優先度**: 高 **見積もり**: 小規模

#### タスク

1. `src/mcp/tools/definitions/element_create.ts` 修正
2. setting タイプのサポート追加
3. テスト追加

---

## 実装順序

1. **Issue #1** - element コマンド完成（CLI + MCP）
   - CLI基盤が他の機能の前提
2. **Issue #2** - lsp validate コマンド実装
   - 原稿検証機能
3. **Issue #4** - MCP element_create 完全実装
   - Issue #1完了後に対応
4. **Issue #3** - OpenRouter/LLM プロバイダー実装
   - 独立して実装可能、最後に統合

---

## 成功基準

- [ ] `storyteller element character --name "hero" --role protagonist` が動作
- [ ] `storyteller element setting --name "kingdom" --type location` が動作
- [ ] `storyteller lsp validate manuscripts/chapter01.md` が動作
- [ ] MCP経由で上記すべての操作が可能
- [ ] OpenRouter APIでLLM分析が動作

---

## 参考ファイル

### CLI実装パターン

- `/home/takets/repos/street-storyteller/src/cli/modules/meta/check.ts`
- `/home/takets/repos/street-storyteller/src/cli/modules/lsp/start.ts`

### MCP実装パターン

- `/home/takets/repos/street-storyteller/src/mcp/tools/definitions/meta_check.ts`
- `/home/takets/repos/street-storyteller/src/mcp/tools/cli_adapter.ts`

### 型定義

- `/home/takets/repos/street-storyteller/src/type/v2/character.ts`
- `/home/takets/repos/street-storyteller/sample/src/types/character.ts`
- `/home/takets/repos/street-storyteller/sample/src/types/setting.ts`
