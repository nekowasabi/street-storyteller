# 伏線アノテーション方式の調査知見

## 調査日

2025-12-21

## 背景・課題

現行の`@伏線ID`インライン方式には以下の問題がある：

- テキストの可読性低下（本文中にIDが混在）
- 文字数カウントの不正確さ
- シンタックスハイライトの混乱
- 日本語テキストとの相性の悪さ

### 問題の具体例

```markdown
「ただし、この魔法は真夜中の12時に解けてしまいます@ガラスの靴の伏線。必ずそれまでにお帰りなさい」
```

---

## 調査した代替案

### 1. Fountain形式 `[[...]]`

- **構文**: `「魔法は真夜中に解けます。」[[ガラスの靴の伏線]]`
- **特徴**: 脚本向け、二重角括弧でノートを囲む
- **利点**: シンプルで視覚的に区別しやすい
- **欠点**: Markdown標準ではない、日本語文中では`[[`が目立つ
- **採否**: ×
- **Source**: https://fountain.io/syntax/

### 2. CriticMarkup形式 `{>>...<<}`

- **構文**: `「魔法は真夜中に解けます。」{>>ガラスの靴の伏線<<}`
- **特徴**: 編集レビュー向け、Obsidian等でプラグインサポートあり
- **利点**: 広く使われている
- **欠点**: 構文が少し長い
- **採否**: △
- **Source**: https://fletcher.github.io/MultiMarkdown-6/syntax/critic.html

### 3. HTMLコメント方式 ★推奨

- **構文（行上）**:
  ```markdown
  <!-- @foreshadowing:ガラスの靴の伏線 -->

  「魔法は真夜中に解けます。」
  ```
- **構文（インライン）**: `「魔法は真夜中に解けます。」<!-- @fs:ガラスの靴 -->`
- **特徴**: 標準的なMarkdown/HTML構文
- **利点**:
  - どのMarkdownパーサでも対応
  - レンダリング時に非表示
  - テキスト本文に影響なし
  - 文字数カウントが正確
- **欠点**: 記述がやや冗長
- **採否**: ◎ **推奨**
- **Source**: https://www.docstomarkdown.pro/comments-in-markdown/

### 4. Material for MkDocs アノテーション方式

- **構文**: `「魔法は真夜中に解けます(1)。」` + 末尾リスト
- **特徴**: 番号マーカーで本文とアノテーションを分離
- **利点**: 本文のクリーンさを完全に保持
- **欠点**: Markdownプレーンテキストでは関連が分かりにくい
- **採否**: ×
- **Source**: https://squidfunk.github.io/mkdocs-material/reference/annotations/

### 5. Obsidian `%%...%%` 方式

- **構文**: `「魔法は真夜中に解けます。」 %%fs:ガラスの靴%%`
- **特徴**: Obsidian固有の構文
- **利点**: シンプル
- **欠点**: Obsidian以外では使えない
- **採否**: ×
- **Source**: https://forum.obsidian.md/

### 6. 外部ファイル方式（Git注釈風）

- **構文**: `manuscripts/chapter02.md.annotations` に `62:foreshadowing:ID`
- **特徴**: 原稿ファイルとは別にアノテーション専用ファイル
- **利点**: 原稿ファイルを完全に汚さない
- **欠点**: ファイル管理が複雑化、行番号のずれ問題
- **採否**: ×

---

## 比較表

| 方式                     | 可読性   | LSP互換性    | 標準互換 | 実装コスト | 採否  |
| ------------------------ | -------- | ------------ | -------- | ---------- | ----- |
| 現行`@ID`インライン      | 低       | 高（実装済） | 低       | -          | 現行  |
| Fountain `[[...]]`       | 中-高    | 中           | 低       | 低         | ×     |
| CriticMarkup `{>>...<<}` | 中       | 中           | 高       | 中         | △     |
| **HTMLコメント**         | **最高** | **中**       | **最高** | **中**     | **◎** |
| 番号参照方式             | 最高     | 低           | 中       | 高         | ×     |
| 外部ファイル方式         | 最高     | 低           | 中       | 高         | ×     |

---

## 推奨案：HTMLコメント行上アノテーション方式

### 選定理由

1. **最高の可読性**: 本文に一切の記号が混入しない
2. **標準互換**: どのMarkdownビューアでもコメントは非表示
3. **LSP検出可能**: 正規表現で容易に検出可能
4. **段階的移行可能**: 既存の`@`方式と併用しながら移行可能
5. **文字数カウント正確**: 本文の文字数に影響しない

### 完全仕様

```markdown
# 基本形式

<!-- @foreshadowing:伏線ID -->

対象テキストの段落

# 短縮形式

<!-- @fs:伏線ID -->

対象テキストの段落

# 複数伏線

<!-- @fs:伏線A @fs:伏線B -->

この段落には複数の伏線

# 特定テキスト指定（精密モード）

<!-- @fs:伏線ID @target:"真夜中の12時" -->

「ただし、この魔法は真夜中の12時に解けてしまいます。必ずそれまでにお帰りなさい」
```

### 変換例

**Before（現行）**:

```markdown
「ただし、この魔法は真夜中の12時に解けてしまいます@ガラスの靴の伏線。必ずそれまでにお帰りなさい」
```

**After（推奨）**:

```markdown
<!-- @foreshadowing:ガラスの靴の伏線 -->

「ただし、この魔法は真夜中の12時に解けてしまいます。必ずそれまでにお帰りなさい」
```

---

## LSP実装への影響

### 検出パターンの追加

```typescript
// PositionedDetectorに追加するパターン
const annotationPatterns = [
  /<!--\s*@foreshadowing:([^\s>]+)\s*-->/g, // 基本形式
  /<!--\s*@fs:([^\s>]+)\s*-->/g, // 短縮形式
];
```

### 既存機能との後方互換性

- 現行`@ID`方式は引き続きサポート
- 信頼度は両方式とも1.0
- displayNames検出（0.9）は本文検出として維持

---

## 実装計画の概要

1. **process1**: アノテーションパーサー・リゾルバー新規実装
2. **process2**: PositionedDetectorへの統合
3. **process3**: 診断機能の拡張
4. **process4**: 移行ツール `storyteller migrate annotations`
5. **process5**: ホバー・定義ジャンプ対応

詳細は `PLAN.md` を参照。

---

## 教訓

- **可読性 vs 機能性のトレードオフ**:
  本文の可読性を最優先し、メタデータは本文外に配置するのがベスト
- **標準互換性の重要性**:
  独自構文よりもHTML/Markdown標準を活用することで、エコシステム全体での互換性を確保
- **段階的移行**:
  既存方式との後方互換性を維持しながら新方式を導入することで、移行リスクを最小化
