# RAG統合実装 - 教訓・知見

## 実装完了日: 2025-12-29

## Technical Lessons

### 1. チャンキング戦略の設計

- **閾値設定**: 3,000文字/15,000文字の閾値は実用的
- **シーン分割**: `##` 見出しベースの分割は日本語コンテンツで良好
- **オーバーラップ**: 10%（500文字）で文脈保持と重複のバランスが取れる

### 2. ドキュメントテンプレート設計

- **専用形式採用**: digrag互換よりもstoryteller専用形式で検索精度向上
- **メタデータ構造化**: FrontMatterにid, title, date, tags, sourcePathを含める
- **関係性の明示**: キャラクター間関係、設定間関係を明示的にセクション化

### 3. インクリメンタル更新

- **ハッシュベース変更検出**: MD5ハッシュで効率的な変更検出
- **状態ファイル管理**: `.rag-state.json` で前回の状態を保持
- **3分類検出**: added, changed, deleted, unchanged の4状態で管理

## Process Lessons

### 1. TDD実践

- **テストファースト**: 型定義テスト→実装→リファクタリングの流れが効果的
- **境界値テスト**: 3000/3001文字の境界値テストで閾値の正確性を保証
- **モック不要**: 純粋関数設計でモックなしテストが可能

### 2. 段階的実装

- **Phase分割**: 基盤→テンプレート→チャンキング→自動更新の順序が依存関係を満たす
- **最小実装優先**: 各Processで動作する最小限の実装を先に完成

## Antipatterns

### 避けるべきパターン

1. **巨大なドキュメント生成**: 6,000文字を超えるチャンクはdigrag制限に抵触
2. **全要素の一括エクスポート**: 大規模プロジェクトでは--incrementalを推奨
3. **Git hookの過剰使用**: 頻繁なコミットでパフォーマンス低下の可能性

## Best Practices

### digrag連携

1. **ワンコマンド化**: `storyteller rag` で export + build を統合
2. **BM25フォールバック**: オフライン環境では `--no-embeddings` オプション
3. **タグフィルタリング**: 要素タイプ（character, setting等）でフィルタリング

### MCP統合

1. **story_directorプロンプト**: RAG検索結果をコンテキストとして活用
2. **リソースとの連携**: storyteller://リソースとRAGドキュメントの相互参照

## 今後の改善点

1. **セマンティック分割**: 15,000文字超の大規模原稿向け分割の実装
2. **embedding キャッシュ**: API コスト削減のためのキャッシュ機構
3. **差分プレビュー**: `--dry-run` での変更プレビュー機能

## 関連ドキュメント

- 設計書: `docs/designs/PLAN_RAG_UNIFIED.md`
- ユーザーガイド: `docs/rag.md`
- 実装: `src/rag/`, `src/cli/modules/rag/`
