# フェーズ0 — CLI基盤とコマンドフレームワーク

本ドキュメントは Issue #6 に向けたアーキテクチャ計画を示し、後続フェーズ（#2〜#5）が拡張できる storyteller CLI の土台を整備する。範囲はコマンドグラフの再構成、パッケージング導線、シェル補完、設定レイヤの強化、UX 一貫性の確保を含む。

---

## 1. ビジョンと非目標
- **ビジョン**: 階層化されたコマンド、堅牢な引数解析、ヘルプ/ロギング/補完による開発者向け UX を備え、既存コマンドとの互換性を維持しつつグローバルにインストール可能なモジュール型 CLI を提供する。
- **必須項目**: ツリー構造のコマンドレジストリ、統一されたヘルプシステム、インストールパイプライン、補完スクリプト生成、設定オーバーライドのレイヤ化、バリデーションフック。
- **非目標**: 新機能コマンド（LSP やマイグレーション等）の実装、ドメインロジックの再設計、外部サービス統合。これらは後続フェーズで扱う。

---

## 2. ハイレベルアーキテクチャ

```
src/
├── cli/
│   ├── command_registry/
│   │   ├── tree.ts
│   │   ├── validator.ts
│   │   └── legacy_adapter.ts
│   ├── descriptors/
│   │   ├── generate.ts
│   │   ├── element.ts
│   │   └── ...
│   ├── help/
│   │   ├── renderer.ts
│   │   └── templates.ts
│   ├── completions/
│   │   ├── generator.ts
│   │   └── writers/
│   │       ├── bash.ts
│   │       └── zsh.ts
│   ├── install/
│   │   ├── build.ts
│   │   └── artifact_manifest.ts
│   └── modules/
│       ├── generate.ts
│       ├── element/
│       └── ...
└── infrastructure/cli/
    ├── packager.ts
    └── completion_fs_adapter.ts
```

- **Command Registry Layer**: 親子関係・エイリアス・共通オプション定義を保持する階層ツリーへ移行する。
- **Descriptor Layer**: 利用方法、オプション、例、補完/ヘルプ向け動的サジェストを宣言的メタデータとして定義する。
- **Presentation Layer**: コンソールヘルプと補完スクリプト出力を共通化するレンダラーを用意し、descriptor データを共有する。
- **Packaging Layer**: `deno compile` やアーティファクト検証、インストーラ/アンインストーラを管理するスクリプト群。
- **Infrastructure Adapters**: 補完ファイルとバイナリをユーザー環境に配置するためのファイルシステムアダプタ。

---

## 3. 機能的な柱

### 3.1 コマンドグラフと実行
- `CommandNode` 抽象を導入し、`name`、`aliases`、`summary`、`usage`、`options`、`subcommands`、`run` を属性として持たせる。
- レジストリはパス要素を再帰的に解決し（例: `element character`）、ユニークなコマンド ID を強制する。
- 祖先ノードからオプションスキーマを継承し、`--log-level` などのグローバルフラグを共有する。
- 既存のフラットハンドラは `legacy_adapter` で包み込み、移行中のレグレッションを防ぐ。

### 3.2 ヘルプとエラー体験
- `help renderer` がコマンドツリーを巡回し、ルート概要・サブコマンド詳細・フラグ説明・例を含むコンテキストヘルプを生成する。
- 未知のコマンド/オプションでは最も近い候補を提示し、`storyteller help <command>` を案内する。
- レジストリ層で `--version` と `--help` の自動処理を提供する。

### 3.3 インストールとパッケージング
- バイナリをコンパイルしチェックサムとアーティファクトマニフェストを生成する `scripts/build_cli.ts` を作成する。
- バイナリ配置（デフォルトは `$HOME/.local/bin`）、PATH 検出、補完セットアップを担う `scripts/install.sh` と `scripts/uninstall.sh`（フェーズ2で実装）を用意する。
- 任意のインストールディレクトリに対応する `--prefix` オプションを提供する。

### 3.4 シェル補完
- descriptor から補完仕様を生成し、コマンド一覧・オプションフラグ・列挙値の整合性を維持する。
- 出力先:
  - Zsh: `${HOME}/.zsh/completions/_storyteller`
  - Bash: `${HOME}/.bash_completion.d/storyteller`
- 将来的なコマンド起点の JSON サジェストに備え、フェーズ0では静的データとプレースホルダを出力する。

### 3.5 設定サーフェス
- `ConfigurationManager` の探索経路にグローバル rc (`~/.storytellerrc`) を自動的に含める。
- CLI フラグ登録を一元化し、descriptor が設定キー（例: `--log-level` → `logging.level`）へのオーバーライドを宣言する。
- コマンドコンテキストに `ConfigSnapshot` を注入し、読み取り専用の高速参照とキャッシュを提供する。

### 3.6 テレメトリとロギングフック
- 各コマンドが `CommandContext.logger` からスコープ付きロガーを取得できるよう保証する。
- コマンド開始・完了・エラーに構造化イベントを付与し、将来の分析基盤に備える。

---

## 4. フェーズ分割

1. **フェーズ0A — レジストリ再設計**
   - ツリーベースのレジストリを実装し、`generate` と `help` ハンドラを legacy adapter 経由で移行する。
   - 重複名・孤立依存・エイリアス衝突を検知するバリデーションを追加する。
   - ユニットテスト（`tests/cli/command_registry.test.ts`）を更新する。

2. **フェーズ0B — Descriptor とヘルプシステム**
   - Descriptor フォーマットを定義し、既存コマンドを移行する。
   - ヘルプリレンダラを実装し、`help` モジュールを descriptor ベースの出力に更新する。
   - ルートおよびサブコマンドのヘルプ出力をスナップショットテストで固定する。

3. **フェーズ0C — パッケージングツール**
   - バージョン付きバイナリ（`storyteller-v${version}-${os}`）を生成するビルドスクリプトを作成する。
   - サイズ・チェックサム・コンパイル引数を含むアーティファクトマニフェストを出力し、CI マトリクス（linux/mac 想定）で `deno compile` を実行する統合テストを追加する。

4. **フェーズ0D — インストール/アンインストールスクリプト**
   - インストールパス、再インストール時の多重対策、PATH 案内を扱うシェルスクリプトを実装する。
   - bats や deno 製シェルハーネスを用いて HOME サンドボックスを模擬するテストを用意する。

5. **フェーズ0E — 補完生成**
   - 補完ジェネレータを実装し、`completions/` 以下に bash/zsh スクリプトを生成する。
   - インストーラから補完スクリプトを配置し、ディレクトリを `source` するようユーザーに案内する。
   - 生成物とスナップショットの差分を検出するリグレッションテストを追加する。

6. **フェーズ0F — 設定拡張**
   - Descriptor で宣言された設定を統合し、`ConfigurationManager` にグローバル rc パスを公開させ、CLI 解析でグローバルオプションに反映する。
   - README にデフォルト値とオーバーライド手順を追記する。

---

## 5. テスト戦略
- **ユニット**: レジストリのグラフ操作、descriptor 検証、補完エミッタの整形、インストーラユーティリティ（パス解決・環境検出）。
- **統合**: 一時ディレクトリでコンパイル済みバイナリを実行し、`storyteller help` や `storyteller generate --help`、`compgen` を用いた基礎的な補完を検証する。
- **スナップショット**: ヘルプ出力、補完スクリプト、マニフェストを固定しドリフトを監視する。
- **CI 強化**: lint/test/build をまとめた GitHub Workflow を追加し、ヘルプ/補完のスナップショット差分で失敗させる。

---

## 6. リスクマネジメント
- **互換性**: フラットコマンド用アダプタをフェーズ0完了までは維持し、全モジュール移行後に非推奨化する。
- **環境差**: インストーラが権限不足の場合の手動手順を提示し、既存インストール検出後の上書きを制御する。
- **補完ドリフト**: `deno task build:completions` による自動再生成を徹底し、descriptor 変更時は必ずコミットさせる。
- **バイナリサイズ**: マニフェストで `deno compile` の出力を監視し、閾値（例: 30 MB）を超えた場合はフラグやツリーシェイキングを調査する。

---

## 7. ドキュメント整備物
- `README.md` にインストール手順、PATH 設定、コマンド概要を追加する。
- `docs/cli/architecture.md` を新設し、コマンドツリー、descriptor、拡張方法をまとめる。
- CONTRIBUTING に `deno task cli:build`、`deno task cli:completions`、`deno task cli:package` などのメンテナンスタスクを明記する。

---

## 8. 受け入れ基準
- `storyteller help` が階層化されたコマンドと要約・例を表示する。
- `install.sh` 経由でバイナリを配置し、PATH に追加され（必要に応じて `--prefix` 指定）、即時利用できる。
- `storyteller generate --help` 実行時に descriptor の内容とオプションが反映され、補完でも同一情報が提示される。
- CI 上でレジストリ検証が成功し、既存テストと追加テストがすべて通過する。
- 補完スクリプトが descriptor から決定的に再生成される。

本計画により、後続フェーズ（型拡張、LSP、メタデータ、LLM 連携など）が依存できる CLI の基盤と、メンテナブルな開発体験を確立する。
