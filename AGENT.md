# AGENT.md

## プロジェクト概要
- **プロダクト名**: Street Storyteller (SaC: StoryWriting as Code)
- **目的**: 物語の構造をTypeScriptで定義・検証し、AI連携で創作体験を革新する。
- **現状**: プロトタイプ段階。アーキテクチャ未整備で拡張性・UXが課題。
- **ゴール**: 12週間でv1.0を完成させ、対話型AIインターフェースまで統合する。

## 開発環境と基本コマンド
- **ランタイム**: Deno 2.2.12
- **言語/テスト**: TypeScript + Deno標準テストランナー
- **主要タスク**:
  - `deno run main.ts` : CLI挙動確認
  - `deno test` / `deno test --watch` : テスト
  - `deno fmt`, `deno lint` : 整形・Lint
  - `deno task build` : バイナリビルド
- **リポジトリ構造**:
  - `src/` : 型・CLI実装（今後整理予定）
  - `sample/` : 拡張型定義と検証例
  - `tests/` : Denoテスト群

## ロードマップ要約（Issue #9より）
| フェーズ | 期間 | 主要成果 | 依存Issue |
|---------|------|----------|-----------|
| Phase 1: 基盤構築 | 2週 | アーキテクチャ整備、CLI基盤、補完 | #7, #6, #2(一部), #10(Phase1) |
| Phase 2: コア機能 | 2週 | 型拡張完了、メタデータ自動化基盤、LSP Stage1 | #2, #4, #3(Stage1), #10(Phase2) |
| Phase 3: 高度化 | 3週 | LSP完成、ブラウザ可視化強化、LLMテストMVP | #3(Stage2-3), #10(Phase3-4), #5 |
| Phase 4: AI統合 | 3週 | storyteller-ai対話層実装 | #8 + 既存全Issue |
| Phase 5: 仕上げ | 2週 | 最適化、ドキュメント、CI/CD、v1.0リリース | 全Issue |

### 即時アクション（Day1-2）
1. アーキテクチャ設計ドキュメント作成 (#7)
2. CLI基盤準備とコマンドレジストリ設計 (#6)
3. CI/CD・テスト体制、貢献ガイド整備 (#6, #9)

## Issue サマリ
- **#10 ブラウザ表示機能**: `storyteller view`/`serve`導入。解析モジュール、HTMLレンダラー、内蔵サーバー、WebSocket監視で物語要素を可視化。Phase1~4で段階実装。依存:#6。
- **#9 ロードマップ統括**: 12週間ロードマップと依存関係管理。全Issueの親。定期レビューとマイルストーン追跡が必須。
- **#8 storyteller-ai**: Claude Code風の対話UIを別レイヤーで実装。自然言語→CLIコマンド変換、文脈保持、AI相談、複雑タスク自動化。プラグイン/マイグレーション構想含む。依存: #2,#3,#4,#5,#6,#7,#10。
- **#7 アーキテクチャ設計**: レイヤード構造、DI、エラーハンドリング、拡張性確保。ディレクトリ再編とインターフェース整備が中心。全機能の土台。
- **#6 CLIインフラ**: コマンドレジストリ、構造化出力(JSON)、補完スクリプト、エラーハンドリング基盤。Phase1で必須。
- **#5 LLMテスト**: YAML定義の自然言語テストランナー、ローカルLLM(Ollama)対応。LSP完成後に品質保証レイヤーを追加。
- **#4 メタデータ自動生成**: `storyteller meta generate`で`.meta.ts`生成。フロントマター解析、参照マッピング、displayNames対応。依存:#2。
- **#3 LSP統合**: Stage1(@付き参照ジャンプ)、Stage2診断、Stage3@なし検出＋信頼度。エディタ連携(neovim/vscode)想定。依存:#2,#4。
- **#2 型システム拡張**: Character型拡張、詳細情報の段階管理、CLIからの追加、検出ヒント、ファイル分離、マイグレーション。後続全Issueのスキーマ基盤。

## Issue 詳細
### #10 ✨ ブラウザ表示機能の実装
- **目的**: 物語要素の一覧性を高め、関係性を可視化。
- **主構成**: `commands/view.ts`, `analyzer/project-analyzer.ts`, `renderer/html-renderer.ts(+templates)`, `server/viewer-server.ts`, `watcher/file-watcher.ts`。
- **UI案**: サイドバー+メインビュー+関係グラフ、キャラクター/設定カード、プロットツリー。
- **進行**: Phase1コマンド/データ取得 → Phase2 HTML → Phase3 サーバー/監視 → Phase4 UI改善。D3.js(任意)検討。

### #9 🎯 Street Storyteller v1.0 ロードマップ
- **役割**: すべてのIssueの親。フェーズ別タスクと依存を明文化。
- **依存図**: #7→#6→(#2,#10)→#4→#3→#5→#8（#10も#8に影響）。
- **完了条件**: コマンド統合、テスト80%超、ドキュメント、CI/CD、性能基準、ビジネス指標達成。
- **運用**: 毎週進捗更新、フェーズ毎にチェックイン。

### #8 storyteller-ai: 対話型AI執筆支援
- **背景課題**: CLI学習コスト、手順の煩雑さ、創作相談不足、エラー解決困難。
- **アプローチ**: storyteller(コア)とstoryteller-ai(対話層)を分離。自然言語コマンド、対話的初期化、文脈分析、複雑タスク自動化。
- **技術要件**: CLIラッパー、コンテキスト管理、プラグインシステム、マイグレーション、AST編集、Markdownジェネレーター、バックアップ。
- **段階**: Phase1~5で段階実装（対話ループ→高度支援→マイグレーション→一括更新等）。

### #7 アーキテクチャ設計
- **狙い**: クリーンアーキテクチャ、層ごとの責務分離、依存逆転、テスト容易性。
- **タスク**: ディレクトリ再設計、ユースケース層の整備、エラーハンドリング統一、設定管理、DI導入。
- **成果物**: 設計ドキュメント、リファレンス実装、開発指針。

### #6 Phase 0: CLIインフラ
- **要件**: コマンドレジストリ、構造化出力(JSON/色付きログ)、補完スクリプト生成、設定ファイル管理、ヘルプ整備。
- **補完**: Bash/Zsh補完ファイル生成/インストール手順。
- **スケジュール**: アーキ設計後すぐ着手（Week1-2）。

### #5 LLMベース自然言語テスト
- **目的**: 意味的・感情的整合性テスト。YAML定義→LLM評価→レポート。
- **MVP**: モック/ローカルLLM対応、Denoスクリプト、詳細レポート。
- **展開**: LSP整備後に品質保証として導入。

### #4 メタデータ自動生成
- **内容**: `storyteller meta generate`でMarkdown/TS連携。displayNames、参照マッピング、chapter meta.ts生成。
- **タスク**: Frontmatter抽出、テンプレート生成、参照整合性チェック。
- **段階**: Step1 基本生成 → Step2 検出/マッピング高度化。

### #3 LSP統合による原稿チェック
- **ステージ**:
  - Stage1: LSPサーバー基盤、@付きジャンプ。
  - Stage2: 基本診断、hover、Code Action。
  - Stage3: @なし検出、信頼度ロジック、曖昧性診断。
- **エディタ統合**: neovim/vscodeキー設定サンプルあり。
- **依存**: 型拡張(#2)・メタデータ(#4)。

### #2 TypeScript型による表現力向上
- **型拡張**: `Character`のハイブリッド詳細、検出ヒント、段階的詳細追加。
- **CLI**: `storyteller element character --with-details`、`--separate-files`、`--add-details` 等。
- **マイグレーション**: スキーマバージョニング、プラグイン化、バックアップ/ロールバック。
- **成果**: 型安全性と柔軟性両立、LSP/AI統合の土台。

## 参考リンク
- リポジトリREADME: `README.md`
- Issue集約: `https://github.com/nekowasabi/street-storyteller/issues`
- 追加ドキュメント: `CLAUDE.md`, `ISSUE.md`, `sample/README.md`

## 運用メモ
- 毎週月曜に進捗レポート更新（Issue #9）。
- Issue更新時は依存先の状態も必ず確認し、チェックリストを同期。
- 大規模変更は`storyteller-ai`分離設計と互換性維持ポリシーを遵守。
